<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高雄捷運查詢器</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Roboto 字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- 引入 Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif; /* Change font to Roboto */
        }
        /* 自定義滾動條樣式 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* 定義旋轉180度的動畫 */
        @keyframes rotate-180 {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(180deg); /* Changed to positive 180 degrees */
            }
        }

        /* 應用動畫的類別 */
        .animate-rotate-once {
            animation: rotate-180 0.5s ease-out forwards; /* 0.5秒完成，保持最終狀態 */
        }
    </style>
</head>
<body class="bg-emerald-50 flex items-center justify-center min-h-screen p-4">
    <!-- Main container styled as a Material 3 card -->
    <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-md border border-emerald-100">
        <h1 class="text-3xl font-bold text-center text-emerald-800 mb-6">高雄捷運查詢</h1>

        <!-- 路線選擇按鈕 -->
        <div class="mb-5 flex justify-center space-x-4">
            <button id="red-line-button" class="flex-1 px-6 py-3 rounded-full font-semibold transition duration-300 ease-in-out transform hover:scale-105 shadow-md hover:shadow-lg bg-red-500 text-white hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                紅線 Red Line
            </button>
            <button id="orange-line-button" class="flex-1 px-6 py-3 rounded-full font-semibold transition duration-300 ease-in-out transform hover:scale-105 shadow-md hover:shadow-lg bg-orange-500 text-white hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2">
                橘線 Orange Line
            </button>
        </div>

        <!-- 站點選擇器 -->
        <div class="mb-5">
            <label for="station-select" class="block text-gray-700 text-sm font-semibold mb-2">選擇捷運站點:</label>
            <select id="station-select" class="block w-full px-4 py-3 border border-emerald-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 text-gray-800 bg-emerald-50 transition duration-200 ease-in-out appearance-none cursor-pointer">
                <!-- 選項將由 JavaScript 動態填充 -->
            </select>
        </div>

        <!-- 查詢結果顯示區 -->
        <div class="mt-6 border border-emerald-200 bg-emerald-50 p-4 rounded-xl min-h-[120px] max-h-96 overflow-y-auto relative shadow-inner">
            <h2 class="text-lg font-semibold text-emerald-700 mb-3 border-b-2 border-emerald-300 pb-2">查詢結果:</h2>
            <!-- 結果將以非表格形式顯示在此 -->
            <div id="results-display" class="text-gray-800 text-sm"></div>
            
            <!-- 錯誤/訊息提示框 -->
            <div id="message-box" class="hidden absolute top-0 left="0" w-full h-full bg-red-100 bg-opacity-90 flex items-center justify-center rounded-xl p-4 text-red-700 text-center font-medium border border-red-300">
                <span id="message-text"></span>
                <button id="close-message" class="absolute top-2 right-2 text-red-600 hover:text-red-800 text-xl font-bold">&times;</button>
            </div>
        </div>

        <!-- 立即更新按鈕 (現在顯示倒數計時) -->
        <div class="flex justify-center mt-6">
            <button id="manual-update-button" class="w-full max-w-xs bg-emerald-600 text-white py-3 px-6 rounded-full font-semibold hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center space-x-2 shadow-md hover:shadow-lg">
                <span id="refresh-icon" class="material-icons text-2xl">cached</span>
                <span id="countdown-text">30秒後更新</span>
            </button>
        </div>
    </div>

    <script>
        // DOM 內容載入完成後執行
        document.addEventListener('DOMContentLoaded', () => {
            // 獲取 HTML 元素
            const redLineButton = document.getElementById('red-line-button');
            const orangeLineButton = document.getElementById('orange-line-button');
            const stationSelect = document.getElementById('station-select');
            const manualUpdateButton = document.getElementById('manual-update-button'); 
            const countdownText = document.getElementById('countdown-text'); // 倒數計時文字顯示
            const resultsDisplay = document.getElementById('results-display');
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            const closeMessageButton = document.getElementById('close-message');
            const refreshIcon = document.getElementById('refresh-icon'); // 獲取刷新圖示元素

            let autoUpdateInterval; // 用於儲存自動更新的計時器 ID (現在也負責倒數)
            let currentCountdown = 30; // 追蹤目前的倒數值
            const UPDATE_INTERVAL = 30; // 自動更新間隔，單位：秒

            // 高雄捷運紅線站點代碼及其名稱
            const redLineStations = {
                "R3": "小港", "R4": "高雄國際機場", "R4A": "草衙", "R5": "前鎮高中", "R6": "凱旋",
                "R7": "獅甲", "R8": "三多商圈", "R9": "中央公園", "R10": "美麗島", "R11": "高雄車站",
                "R12": "後驛", "R13": "凹子底", "R14": "巨蛋", "R15": "生態園區", "R16": "左營",
                "R17": "世運",
                "R18": "油廠國小", // 新增站點
                "R19": "楠梓科技園區", // 更改名稱
                "R20": "後勁",
                "R21": "都會公園",
                "R22": "青埔",
                "R22A": "橋頭糖廠",
                "R23": "橋頭火車站",
                "R24": "岡山高醫",
                "RK1": "岡山車站"
            };

            // 高雄捷運橘線站點代碼及其名稱
            const orangeLineStations = {
                "O1": "哈瑪星", // 更改名稱
                "O2": "鹽埕埔",
                "O3": "前金", // 新增站點
                "O4": "市議會",
                "O5": "美麗島",
                "O6": "信義國小",
                "O7": "文化中心",
                "O8": "五塊厝",
                "O9": "苓雅運動園區", // 更改名稱
                "O10": "衛武營",
                "O11": "鳳山西站", // 更改名稱
                "O12": "鳳山",
                "O13": "大東",
                "O14": "鳳山國中", // 更改名稱
                "OT1": "大寮" // 新增站點，假設為 O15
            };

            // 合併所有站點，用於查詢時的名稱對應
            const allStations = { ...redLineStations, ...orangeLineStations };

            let currentLineStations = redLineStations; // 預設為紅線站點

            /**
             * 根據選定的路線填充站點選擇器
             * @param {object} stationsData 包含站點代碼和名稱的物件
             */
            function populateStationSelect(stationsData) {
                stationSelect.innerHTML = ''; // 清空現有選項
                for (const code in stationsData) {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = `${code} - ${stationsData[code]}`;
                    stationSelect.appendChild(option);
                }
                // 如果沒有站點，禁用選擇器
                stationSelect.disabled = Object.keys(stationsData).length === 0;
            }

            /**
             * 設置路線按鈕的活躍狀態
             * @param {HTMLElement} activeButton 要設置為活躍的按鈕
             * @param {HTMLElement} inactiveButton 要設置為非活躍的按鈕
             */
            function setActiveLineButton(activeButton, inactiveButton) {
                activeButton.classList.remove('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
                activeButton.classList.add('bg-emerald-600', 'text-white', 'hover:bg-emerald-700');
                
                inactiveButton.classList.remove('bg-emerald-600', 'text-white', 'hover:bg-emerald-700');
                inactiveButton.classList.add('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
            }

            // 紅線按鈕事件監聽器
            redLineButton.addEventListener('click', () => {
                currentLineStations = redLineStations;
                populateStationSelect(currentLineStations);
                setActiveLineButton(redLineButton, orangeLineButton);
                fetchMRTData(); // 重新獲取資料
                startAutoUpdateAndCountdown(); // 重啟倒數
            });

            // 橘線按鈕事件監聽器
            orangeLineButton.addEventListener('click', () => {
                currentLineStations = orangeLineStations;
                populateStationSelect(currentLineStations);
                setActiveLineButton(orangeLineButton, redLineButton);
                fetchMRTData(); // 重新獲取資料
                startAutoUpdateAndCountdown(); // 重啟倒數
            });

            /**
             * 顯示訊息框
             * @param {string} message 要顯示的訊息
             * @param {string} type 訊息類型 ('success', 'error', 'info')，用於樣式調整
             */
            function showMessage(message, type = 'info') {
                messageText.textContent = message;
                messageBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'bg-emerald-100', 'border-red-300', 'border-green-300', 'border-emerald-300', 'text-red-700', 'text-green-700', 'text-emerald-700');
                
                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'border-red-300', 'text-red-700');
                } else if (type === 'success') {
                    messageBox.classList.add('bg-green-100', 'border-green-300', 'text-green-700');
                } else { // info
                    messageBox.classList.add('bg-emerald-100', 'border-emerald-300', 'text-emerald-700');
                }
                messageBox.classList.remove('hidden');
                resultsDisplay.classList.add('hidden'); // 隱藏結果顯示區
            }

            /**
             * 隱藏訊息框
             */
            function hideMessageBox() {
                messageBox.classList.add('hidden');
                resultsDisplay.classList.remove('hidden'); // 重新顯示結果顯示區
            }

            // 關閉訊息框按鈕的事件監聽器
            closeMessageButton.addEventListener('click', hideMessageBox);

            /**
             * 更新倒數計時器顯示
             */
            function updateCountdownDisplay() {
                manualUpdateButton.disabled = false; // 確保按鈕在倒數時是可點擊的
                manualUpdateButton.classList.remove('opacity-50', 'cursor-not-allowed');

                if (currentCountdown <= 0) {
                    countdownText.textContent = `更新中...`; // 顯示更新中
                    manualUpdateButton.disabled = true; // 禁用按鈕防止重複點擊
                    manualUpdateButton.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    countdownText.textContent = `${currentCountdown}秒後更新`;
                }
            }

            /**
             * 啟動或重置自動更新和倒數計時器
             */
            function startAutoUpdateAndCountdown() {
                clearInterval(autoUpdateInterval); // 清除任何現有的計時器
                currentCountdown = UPDATE_INTERVAL; // 重置倒數
                updateCountdownDisplay(); // 立即更新顯示

                autoUpdateInterval = setInterval(() => {
                    currentCountdown--;
                    updateCountdownDisplay();

                    if (currentCountdown <= 0) {
                        fetchMRTData(); // 倒數結束，獲取資料
                        currentCountdown = UPDATE_INTERVAL; // 重置倒數為下一個週期
                    }
                }, 1000); // 每秒更新
            }

            /**
             * 獲取並顯示捷運資料的核心函數
             */
            async function fetchMRTData() {
                const selectedStationCode = stationSelect.value;
                if (!selectedStationCode) {
                    resultsDisplay.innerHTML = `<p class="text-gray-600 text-center">請先選擇一個捷運站點。</p>`;
                    showMessage(`請先選擇一個捷運站點。`, 'info');
                    manualUpdateButton.disabled = false;
                    manualUpdateButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    return;
                }

                const proxyUrl = `https://krtc.potatosserver.workers.dev/?station=${selectedStationCode}`;

                manualUpdateButton.disabled = true; // 禁用立即更新按鈕
                manualUpdateButton.classList.add('opacity-50', 'cursor-not-allowed');
                refreshIcon.classList.add('animate-rotate-once'); // 添加旋轉動畫類別

                hideMessageBox(); // 隱藏任何之前的訊息

                try {
                    const response = await fetch(proxyUrl);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP 錯誤！狀態碼: ${response.status}`);
                    }
                    const data = await response.json();

                    if (Object.keys(data).length === 0) {
                        resultsDisplay.innerHTML = `<p class="text-gray-600 text-center">沒有找到 ${allStations[selectedStationCode] || selectedStationCode} 站點的即時資訊。</p>`;
                        showMessage(`沒有找到 ${allStations[selectedStationCode] || selectedStationCode} 站點的即時資訊。`, 'info');
                    } else {
                        resultsDisplay.innerHTML = ''; 
                        resultsDisplay.classList.remove('hidden'); 

                        // 創建一個容器來存放每個捷運班次的資訊
                        const trainListContainer = document.createElement('div');
                        trainListContainer.classList.add('space-y-4'); 

                        for (const key in data) {
                            const [fromStationCode, toStationCode] = key.split('_');
                            const toName = allStations[toStationCode] || toStationCode; 
                            const value = data[key]; 
                            
                            let timeHtml = ''; // 用於最終顯示的 HTML
                            
                            if (value === "進站中") {
                                timeHtml = `<span class="text-3xl">${value}</span>`; // 進站中直接放大
                            } else {
                                const [hours, minutes] = value.split('_'); 
                                const parsedHours = parseInt(hours);
                                const parsedMinutes = parseInt(minutes);

                                if (parsedHours === 0 && parsedMinutes === 0) { // If both hours and minutes are 0
                                    timeHtml = `<span class="text-3xl">進站中</span>`; // 0小時0分鐘也顯示進站中並放大
                                } else if (parsedHours > 0) {
                                    timeHtml = `預計 <span class="text-3xl">${parsedHours}</span> 小時 <span class="text-3xl">${parsedMinutes}</span> 分鐘 到達`;
                                } else {
                                    timeHtml = `預計 <span class="text-3xl">${parsedMinutes}</span> 分鐘 到達`;
                                }
                            }

                            // 創建一個 div 來顯示單個班次的資訊
                            const trainItem = document.createElement('div');
                            trainItem.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-emerald-100', 'flex', 'flex-col', 'gap-y-4'); // Changed gap to gap-y-4

                            // 終點站 (縮小文字)
                            const toStationDiv = document.createElement('div');
                            toStationDiv.classList.add('text-sm', 'font-semibold', 'text-gray-900'); // text-sm for smaller
                            toStationDiv.textContent = `往 ${toName} (${toStationCode})`;
                            trainItem.appendChild(toStationDiv);

                            // 預計抵達時間 (根據內容動態調整字體大小，並靠右對齊)
                            const timeDisplayDiv = document.createElement('div');
                            timeDisplayDiv.classList.add('text-sm', 'text-gray-700', 'text-right'); // Explicitly set text-sm for the container and text-right
                            timeDisplayDiv.innerHTML = timeHtml; // Use innerHTML to render spans
                            trainItem.appendChild(timeDisplayDiv);

                            trainListContainer.appendChild(trainItem);
                        }
                        resultsDisplay.appendChild(trainListContainer);
                    }
                } catch (error) {
                    console.error('獲取捷運資料失敗:', error);
                    resultsDisplay.innerHTML = `<p class="text-red-600 text-center">錯誤: 無法獲取捷運資料。<br>${error.message}</p>`;
                    showMessage(`錯誤: 無法獲取捷運資料。${error.message}`, 'error');
                } finally {
                    manualUpdateButton.disabled = false; 
                    manualUpdateButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    // 在動畫完成後移除類別，以便下次點擊時重新觸發
                    refreshIcon.classList.remove('animate-rotate-once'); 
                }
            }

            // 站點選擇器變更時自動查詢
            stationSelect.addEventListener('change', () => {
                fetchMRTData(); 
                startAutoUpdateAndCountdown(); 
            });

            // 立即更新按鈕的事件監聽器
            manualUpdateButton.addEventListener('click', () => {
                fetchMRTData(); 
                startAutoUpdateAndCountdown(); 
            });

            // 初始化時：預設選擇紅線，填充站點，並觸發一次查詢
            populateStationSelect(redLineStations);
            setActiveLineButton(redLineButton, orangeLineButton); // 設置紅線按鈕為活躍狀態
            fetchMRTData();
            startAutoUpdateAndCountdown();
        });
    </script>
</body>
</html>
